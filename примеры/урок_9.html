<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">

  <script src="../художник.js"></script>

  <script>

    окно.после_загрузки = async function () {

      модель_звезды            = await запрос( 'модели/урок_9_звезда.json' )
      код_вершинного_шейдера   = await запрос( 'шейдеры/урок_9_вершинный_шейдер.glsl' )
      код_фрагментного_шейдера = await запрос( 'шейдеры/урок_9_фрагментный_шейдер.glsl' )

      таблица_соответствия_данным_модели_и_переменным_шейдеров = {
        вершины            : 'atribut_poziciya_vershin',
        координаты_текстуры: 'atribut_koordinaty_tekstury',
      }


      звёзды           = []
      количество_звёзд = 50

      мерцание = нет

      камера.расстояние_до_цели                 = -20.0
      камера.тангаж                             = 90
      угол_поворота_звёзд_вокруг_собственой_оси = 0


      for (let счётчик = 0; счётчик < количество_звёзд; счётчик++) {
        let звезда                         = {}
        звезда.угол                        = 0
        звезда.дистанция                   = (счётчик / количество_звёзд) * 5.0
        звезда.скорость_вращения_по_орбите = счётчик / количество_звёзд

        звезда.красный = получить_случайное_число()
        звезда.зелёный = получить_случайное_число()
        звезда.синий   = получить_случайное_число()

        звезда.красный_для_мерцания = получить_случайное_число()
        звезда.зелёный_для_мерцания = получить_случайное_число()
        звезда.синий_для_мерцания   = получить_случайное_число()

        Объект.копировать( звезда, модель_звезды )

        звёзды.добавить( звезда )
      }

      модель_звезды.данные_текстуры.путь_к_файлу = 'модели/' + модель_звезды.данные_текстуры.название_файла

      текущие_нажатые_клавиши = []

      документ.добавить_выполнение_функции_к_событию_этого_объекта( 'keydown', обработчик_опускания_клавиш )
      документ.добавить_выполнение_функции_к_событию_этого_объекта( 'keyup', обработчик_поднимания_клавиш )

      функции_для_постоянного_повторения.добавить( обработчик_нажатий_клавиш )
      функции_для_постоянного_повторения.добавить( изменение_свойств_звёзд )

      холст_1    = Холст( 'холст_1' )
      художник_1 = Художник( холст_1, код_вершинного_шейдера, код_фрагментного_шейдера,
                             таблица_соответствия_данным_модели_и_переменным_шейдеров )

      художник_1.цвет_для_очистки    = [0.0, 0.0, 0.0, 1.0]
      художник_1.включить_смешивание = да

      художник_1.функция_для_передачи_нестандартных_данных_в_шейдер = function ( предмет ) {

        if (мерцание) {
          художник_1.передать_вектор_со_значениями_с_плавающей_точкой_в_одной_переменной(
            художник_1.получить_расположение_переменной( художник_1.шейдерная_программа, "uniform_cvet" ),
            [предмет.красный_для_мерцания, предмет.зелёный_для_мерцания, предмет.синий_для_мерцания] )
        }

        художник_1.передать_вектор_со_значениями_с_плавающей_точкой_в_одной_переменной(
          художник_1.получить_расположение_переменной( художник_1.шейдерная_программа, "uniform_cvet" ),
          [предмет.красный, предмет.зелёный, предмет.синий] )
      }

      художник_1.афинные_преобразования = function ( матрица_модель_вид, предмет ) {
        вращать_матрицу( матрица_модель_вид, градусы_в_радианы( предмет.угол ), [0.0, 1.0, 0.0] )
        перенести_матрицу( матрица_модель_вид, [предмет.дистанция, 0.0, 0.0] )
        вращать_матрицу( матрица_модель_вид, градусы_в_радианы( -предмет.угол ), [0.0, 1.0, 0.0] )
        вращать_матрицу( матрица_модель_вид, градусы_в_радианы( -камера.тангаж ), [1.0, 0.0, 0.0] )
        вращать_матрицу( матрица_модель_вид, градусы_в_радианы( угол_поворота_звёзд_вокруг_собственой_оси ),
                         [0.0, 0.0, 1.0] );
      }

      художник_1.нарисуй( звёзды )
    }

    function изменение_свойств_звёзд() {
      for (let счётчик = 0; счётчик < количество_звёзд; счётчик++) {

        звёзды[счётчик].угол += звёзды[счётчик].скорость_вращения_по_орбите * время_с_последней_отсечки / 10;
        звёзды[счётчик].дистанция -= 0.01 * время_с_последней_отсечки / 10;
        if (звёзды[счётчик].дистанция < 0.0) {
          звёзды[счётчик].дистанция += 5.0;

          звёзды[счётчик].красный = получить_случайное_число()
          звёзды[счётчик].зелёный = получить_случайное_число()
          звёзды[счётчик].синий   = получить_случайное_число()

          звёзды[счётчик].красный_для_мерцания = получить_случайное_число()
          звёзды[счётчик].зелёный_для_мерцания = получить_случайное_число()
          звёзды[счётчик].синий_для_мерцания   = получить_случайное_число()
        }
      }

      угол_поворота_звёзд_вокруг_собственой_оси += 3
    }


    function обработчик_опускания_клавиш( событие ) {
      текущие_нажатые_клавиши[событие.код_клавиши] = да
    }

    function обработчик_поднимания_клавиш( событие ) {
      текущие_нажатые_клавиши[событие.код_клавиши] = нет
    }

    function обработчик_нажатий_клавиш() {
      // клавиша №33 'PageUp'
      if (текущие_нажатые_клавиши[33]) камера.расстояние_до_цели -= 0.05

      // клавиша №34 'PageDown'
      if (текущие_нажатые_клавиши[34]) камера.расстояние_до_цели += 0.05

      // клавиша №38 'стрелка вверх' или №87 'Ц(рус)/W(анг)'
      if (текущие_нажатые_клавиши[38] || текущие_нажатые_клавиши[87]) камера.тангаж -= 2;

      // клавиша №40 'стрелка вниз' или №83 'Ы(рус)/S(анг)'
      if (текущие_нажатые_клавиши[40] || текущие_нажатые_клавиши[83]) камера.тангаж += 2;
    }

  </script>

  <title>Урок 8. Буфер глубины, прозрачность и смешивание</title>
</head>

<body>

<div id="контейнер">
  <canvas id="холст_1" width="500" height="500"></canvas>
  <div>
    <a href="index.html">< Назад</a>
  </div>
</div>

</body>
</html>