<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">

  <script src="../художник.js"></script>

  <script>

    окно.после_загрузки = async function () {

      количество_граней_по_широте  = 30
      количество_граней_по_долготе = 30
      радиус                       = 2
      данные_координат_вершин      = []
      данные_нормалей              = []
      данные_координат_текстуры    = []
      for (let номер_по_широте = 0; номер_по_широте <= количество_граней_по_широте; номер_по_широте++) {
        let тета         = (номер_по_широте * 180 / количество_граней_по_широте)
        let синус_тета   = синус( тета )
        let косинус_тета = косинус( тета )

        for (let номер_по_долготе = 0; номер_по_долготе <= количество_граней_по_долготе; номер_по_долготе++) {
          let фи         = (номер_по_долготе * 2 * 180 / количество_граней_по_долготе)
          let синус_фи   = синус( фи )
          let косинус_фи = косинус( фи )

          let абсцисса             = косинус_фи * синус_тета
          let ордината             = косинус_тета
          let аппликата            = синус_фи * синус_тета
          let вертикаль_текстуры   = 1 - (номер_по_долготе / количество_граней_по_долготе)
          let горизонталь_текстуры = 1 - (номер_по_широте / количество_граней_по_широте)

          данные_нормалей.добавить( абсцисса )
          данные_нормалей.добавить( ордината )
          данные_нормалей.добавить( аппликата )
          данные_координат_текстуры.добавить( вертикаль_текстуры )
          данные_координат_текстуры.добавить( горизонталь_текстуры )
          данные_координат_вершин.добавить( радиус * абсцисса )
          данные_координат_вершин.добавить( радиус * ордината )
          данные_координат_вершин.добавить( радиус * аппликата )
        }
      }

      данные_индексов = []
      for (let номер_по_широте = 0; номер_по_широте < количество_граней_по_широте; номер_по_широте++) {
        for (let номер_по_долготе = 0; номер_по_долготе < количество_граней_по_долготе; номер_по_долготе++) {
          let первая_вершина = (номер_по_широте * (количество_граней_по_долготе + 1)) + номер_по_долготе
          let вторая_вершина = первая_вершина + количество_граней_по_долготе + 1
          данные_индексов.добавить( первая_вершина )
          данные_индексов.добавить( вторая_вершина )
          данные_индексов.добавить( первая_вершина + 1 )

          данные_индексов.добавить( вторая_вершина )
          данные_индексов.добавить( вторая_вершина + 1 )
          данные_индексов.добавить( первая_вершина + 1 )
        }
      }

      луна = {
        вершины        : данные_координат_вершин,
        индексы        : данные_индексов,
        нормали        : данные_нормалей,
        данные_текстуры: {
          название_файла: "moon.gif",
          координаты    : данные_координат_текстуры
        }
      }


      код_вершинного_шейдера   = await запрос( 'шейдеры/урок_11_вершинный_шейдер.glsl' )
      код_фрагментного_шейдера = await запрос( 'шейдеры/урок_11_фрагментный_шейдер.glsl' )

      таблица_соответствия_данным_модели_и_переменным_шейдеров = {
        вершины            : 'atribut_poziciya_vershin',
        координаты_текстуры: 'atribut_koordinaty_tekstury',
        нормали            : 'atribut_normali_vershin',
      }

      луна.данные_текстуры.путь_к_файлу = 'модели/' + луна.данные_текстуры.название_файла

      холст_1    = Холст( 'холст_1' )
      художник_1 = Художник( холст_1, код_вершинного_шейдера, код_фрагментного_шейдера,
                             таблица_соответствия_данным_модели_и_переменным_шейдеров )

      холст_1.обработчик_опускания_клавиши_мыши   = обработчик_опускания_клавиши_мыши
      документ.обработчик_поднимания_клавиши_мыши = обработчик_поднимания_клавиши_мыши
      документ.обработчик_перемещения_мыши        = обработчик_перемещения_мыши

      камера.расстояние_до_цели = 6.0

      художник_1.свет_включён                 = да
      художник_1.направление_света            = [-1.0, -1.0, -1.0]
      художник_1.цвет_направленного_освещения = [0.8, 0.8, 0.8]
      художник_1.цвет_фонового_освещения      = [0.2, 0.2, 0.2]

      художник_1.цвет_для_очистки = [0.0, 0.0, 0.0, 1.0]

      художник_1.афинные_преобразования = function ( матрица_модель_вид ) {
        умножить_матрицы_четвёртого_порядка( матрица_модель_вид, матрица_поворота_луны )
      }

      художник_1.нарисуй( [луна] )
    }


    клавиша_мыши_опущена    = нет
    последняя_абсцисса_мыши = пусто
    последняя_ордината_мыши = пусто

    матрица_поворота_луны = получить_единичную_матрицу_четвёртого_порядка()

    function обработчик_опускания_клавиши_мыши( событие ) {
      клавиша_мыши_опущена    = да
      последняя_абсцисса_мыши = событие.абсцисса_относительно_клиентской_области
      последняя_ордината_мыши = событие.ордината_относительно_клиентской_области
    }

    function обработчик_поднимания_клавиши_мыши() {
      клавиша_мыши_опущена = нет
    }

    function обработчик_перемещения_мыши( событие ) {
      if (!клавиша_мыши_опущена) return

      новая_абсцисса = событие.абсцисса_относительно_клиентской_области
      новая_ордината = событие.ордината_относительно_клиентской_области

      разность_абсцисс            = новая_абсцисса - последняя_абсцисса_мыши
      новая_матрица_поворота_луны = получить_единичную_матрицу_четвёртого_порядка()
      вращать_матрицу( новая_матрица_поворота_луны, градусы_в_радианы( разность_абсцисс / 10 ), [0, 1, 0] )

      разность_ординат = новая_ордината - последняя_ордината_мыши
      вращать_матрицу( новая_матрица_поворота_луны, градусы_в_радианы( разность_ординат / 10 ), [1, 0, 0] )

      умножить_матрицы_четвёртого_порядка( новая_матрица_поворота_луны, матрица_поворота_луны, матрица_поворота_луны )

      последняя_абсцисса_мыши = новая_абсцисса
      последняя_ордината_мыши = новая_ордината
    }
  </script>

  <title>Урок 11. Сферы, матрицы поворотов и события мыши</title>
</head>

<body>

<div id="контейнер">
  <canvas id="холст_1" width="500" height="500"></canvas>
  <div>
    <a href="index.html">< Назад</a>
  </div>
</div>

</body>
</html>